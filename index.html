<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é•·ç…§éšªäº’å‹•åœ°åœ–ï¼šå¤šç« ç¯€ï¼‹é †åºé—–é—œï¼‹è­‰æ›¸ï¼ˆv3cï¼Œå®Œæˆå…ˆå‡ºè­‰æ›¸ï¼‰</title>
<style>
  :root{
    --paper:#f7f1e1; --ink:#2b2b2b; --gold:#b6863b; --ok:#2e7d32; --no:#b71c1c;
    --shadow:0 10px 30px rgba(30,20,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--paper);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink)}
  header,footer{max-width:1280px;margin:0 auto;padding:12px 16px}
  h1{margin:.2em 0 0;font-size:clamp(22px,3vw,32px)}
  .pill{display:inline-block;margin-right:8px;padding:6px 10px;border:1px dashed var(--gold);border-radius:999px;background:linear-gradient(#fff7e5,#efdfbf);font-size:12px}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;background:linear-gradient(#fff,#f3e3c6);box-shadow:var(--shadow);font-weight:600;cursor:pointer}
  .wrap{max-width:1280px;margin:0 auto;padding:0 16px 20px}
  .chapbar{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 10px}
  .chap{padding:8px 12px;border-radius:999px;border:1px solid #d8c49c;background:#fff;cursor:pointer}
  .chap.active{background:linear-gradient(#fff7e5,#efdfbf);border-color:#b6863b} .chap.done::after{content:"âœ“";margin-left:6px;color:#2e7d32}
  .board{position:relative;aspect-ratio:16/9;width:100%;border-radius:20px;overflow:hidden;border:2px solid #e1cfa6;background:#f5ebcf;box-shadow:var(--shadow);isolation:isolate}
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;filter:contrast(1.02) saturate(1.03)}
  .spot{position:absolute;transform:translate(-50%,-50%);display:grid;place-items:center;width:min(9vw,74px);height:min(9vw,74px);min-width:52px;min-height:52px;border-radius:50%;
        background:radial-gradient(circle at 30% 30%,#fff,#f0dcb6 70%);border:2px solid #b6863b;box-shadow:0 12px 24px rgba(0,0,0,.22);cursor:pointer;z-index:3}
  .spot.locked{filter:grayscale(1) opacity(.65);cursor:not-allowed}
  .spot.completed{background:radial-gradient(circle at 30% 30%,#ecffe8,#c7f0c4 70%);border-color:#6aa26b}
  .spot .label{position:absolute;top:100%;left:50%;transform:translate(-50%,10px);background:rgba(255,255,255,.9);padding:4px 8px;border-radius:8px;border:1px dashed #b6863b;font-size:12px;white-space:nowrap}
  .mascot{position:absolute;left:10%;top:80%;transform:translate(-50%,-50%);z-index:4;width:min(12vw,120px);transition:left .9s ease, top .9s ease}
  .inventory{margin:12px 0 0;padding:12px;border:1px dashed #b6863b;border-radius:12px;background:linear-gradient(#fffdf8,#efe5cb);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .token{padding:6px 10px;border-radius:10px;background:#fff;border:1px solid #d7c39a;min-width:48px;text-align:center;font-size:14px;opacity:.45}
  .token.unlock{opacity:1}
  dialog{border:none;border-radius:16px;padding:0;max-width:min(640px,92vw);box-shadow:var(--shadow)}
  .modal{padding:18px;background:linear-gradient(#fff,#f5ecd9);border:1px solid #e6d7b7;border-radius:16px}
  .q-title{margin:0 0 8px;font-size:18px;font-weight:700}
  .choices{display:grid;gap:8px;margin:12px 0}
  .choice{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #e3d3af;border-radius:12px;background:#fff}
  .feedback{display:none;margin-top:10px;padding:10px;border-radius:10px}
  .feedback.ok{display:block;background:#ecf7ec;border:1px solid #b6e0ba;color:#1b5e20}
  .feedback.no{display:block;background:#fdeaea;border:1px solid #f2b5b5;color:#7f1d1d}
  footer{color:#6b5a3a;font-size:12px}
</style>
</head>
<body>
<header>
  <span class="pill">ğŸ—ºï¸ å¤šç« ç¯€ï¼ˆv3cï¼‰</span>
  <h1>é•·ç…§éšªäº’å‹•åœ°åœ–</h1>
</header>

<div class="wrap">
  <div class="chapbar">
    <button id="chap0" class="chap active">ç¬¬ 1 ç« ï½œæµ·å²¸ç¾¤å³¶</button>
    <button id="chap1" class="chap">ç¬¬ 2 ç« ï½œå·–å³°ç§˜å¢ƒ</button>
    <span style="margin-left:auto"></span>
    <span class="pill" id="progressPill">é€²åº¦ï¼š0 / 10</span>
    <button class="btn" id="resetBtn">é‡ç© / æ¸…é€²åº¦</button>
  </div>

  <div id="board" class="board" role="application" aria-label="äº’å‹•åœ°åœ–">
    <img id="bg" class="bg" alt="åœ°åœ–èƒŒæ™¯" />
    <!-- ä¿ç•™ v3 çš„ SVG å‰ç¥¥ç‰© -->
    <svg id="mascot" class="mascot" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-label="å‰ç¥¥ç‰©">
      <defs>
        <filter id="drop"><feDropShadow dx="0" dy="3" stdDeviation="3" flood-opacity=".35"/></filter>
      </defs>
      <circle cx="60" cy="60" r="40" fill="#8fd18a" filter="url(#drop)"/>
      <circle cx="48" cy="52" r="6" fill="#243b2e"/><circle cx="72" cy="52" r="6" fill="#243b2e"/>
      <path d="M40 78 Q60 92 80 78" stroke="#243b2e" stroke-width="6" fill="none" stroke-linecap="round"/>
      <circle cx="34" cy="46" r="6" fill="#8fd18a"/><circle cx="86" cy="46" r="6" fill="#8fd18a"/>
    </svg>
  </div>

  <div class="inventory" aria-live="polite">
    <strong>ğŸ’ å¯¶ç‰©è¢‹ï¼š</strong>
    <div class="token" id="token1">ğŸš å®ˆè­·è²æ®¼</div>
    <div class="token" id="token2">ğŸ’ æ™ºæ…§å¯¶çŸ³</div>
    <div class="token" id="token3">ğŸŒ¿ è—¤è”“ä¹‹å¿ƒ</div>
    <div class="token" id="token4">â³ æ™‚ä¹‹çŸ³</div>
    <div class="token" id="token5">âš“ å®‰å¿ƒéŒ¨</div>
    <div class="token" id="token6">ğŸªµ æ¨¹ç²¾è­·ç¬¦</div>
    <div class="token" id="token7">ğŸª¨ å·–å³°å¾½ç« </div>
    <div class="token" id="token8">ğŸ”¥ é¤˜ç‡¼ç«ç¨®</div>
    <div class="token" id="token9">ğŸ’§ æ¸…æ³‰ä¹‹æ»´</div>
    <div class="token" id="token10">ğŸŒŸ æ˜Ÿå…‰ä»¤ç‰Œ</div>
    <span style="flex:1"></span><span class="pill" id="statusMsg">ä¾é †åºé—–é—œï¼›å·²é€šéå¯å›çœ‹æ­£è§£</span>
  </div>
</div>

<!-- é¡Œç›®è¦–çª— -->
<dialog id="qDialog" aria-labelledby="qTitle">
  <form method="dialog" class="modal" id="qForm">
    <h2 class="q-title" id="qTitle">æŒ‘æˆ°</h2>
    <p id="qText">â€¦â€¦</p>
    <div class="choices" id="qChoices"></div>
    <div class="feedback" id="qFeedback"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" type="button" value="cancel" onclick="document.getElementById('qDialog').close()">å…ˆç­‰ç­‰</button>
      <button class="btn" id="confirmBtn" type="submit" value="ok">ç¢ºèªç­”æ¡ˆ</button>
    </div>
  </form>
</dialog>

<!-- é€šé—œï¼‹è­‰æ›¸ -->
<dialog id="finishDialog" aria-labelledby="finishTitle">
  <div class="modal">
    <h2 class="q-title" id="finishTitle">ğŸ‰ å…¨ç« ç¯€é€šé—œï¼</h2>
    <p>è¼¸å…¥ä½ çš„åç¨±ï¼Œä¸‹è¼‰èŠ±é‚Šé›»å­è­‰æ›¸ï¼ˆPNGï¼‰ã€‚</p>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label for="certName">åç¨±ï¼š</label>
      <input id="certName" type="text" placeholder="è¼¸å…¥åå­—" style="padding:8px 10px;border:1px solid #ccb78e;border-radius:8px"/>
      <button class="btn" id="makeCertBtn" type="button">ç”Ÿæˆé›»å­è­‰æ›¸</button>
    </div>
    <div style="margin-top:10px;text-align:right"><button class="btn" id="finishCloseBtn" type="button">å¤ªæ£’äº†ï¼</button></div>
  </div>
</dialog>

<footer>â“˜ æ•™è‚²ç”¨é€”ç¤ºç¯„ï¼šé¡Œç›®ç‚ºä¸€èˆ¬æ€§ä¿éšªèˆ‡é•·ç…§çŸ¥è­˜ï¼Œå¯¦éš›ä¿éšœä»¥å„å•†å“æ¢æ¬¾ç‚ºæº–ã€‚</footer>

<script>
(function(){
  // ---- ç« ç¯€è³‡æ–™ ----
  const CHAPTERS = [
    { key:'coast', name:'ç¬¬ 1 ç« ï½œæµ·å²¸ç¾¤å³¶',
      bg:'https://media.istockphoto.com/id/841151358/vector/old-map-of-the-north-sea-britain-and-scandinavia-vector-illustration.jpg?s=2048x2048&w=is&k=20&c=lSjP2_vG54PZgb7gDmS5hUkRCIl8yFp_6IBVUWjQhds=',
      trailSpots:[
        {id:1,left:'10%',top:'75%',label:'æ£•æ«šæµ·ç˜',reward:'token1', q:{t:'é•·ç…§éšªä¸»è¦åœ¨ä¿éšœä»€éº¼æƒ…æ³ï¼Ÿ',c:{A:'æ„Ÿå†’ç™¼ç‡’',ç”Ÿç†æˆ–èªçŸ¥éšœç¤™å°è‡´éœ€é•·æœŸç…§è­·',C:'é–€ç‰™æ–·è£‚ç¾å®¹ä¿®å¾©'},a:'B'}},
        {id:2,left:'28%',top:'63%',label:'æ™ºæ…§ç‡ˆå¡”',reward:'token2', q:{t:'é•·ç…§éšªå¸¸è¦‹çµ¦ä»˜å‹æ…‹æ˜¯ï¼Ÿ',c:{A:'ä¸€æ¬¡é‡‘ + æœˆçµ¦ä»˜/å¹´çµ¦ä»˜',B:'äº¤é€šè£œåŠ© + è—¥è²»è£œåŠ©',C:'æ—…å¹³éšªç†è³ '},a:'A'}},
        {id:3,left:'46%',top:'56%',label:'å¥åº·å¢æ—',reward:'token3', q:{t:'ã€Œç­‰å¾…æœŸã€çš„æ„ç¾©æ˜¯ï¼Ÿ',c:{A:'æŠ•ä¿ç•¶å¤©å³ç”Ÿæ•ˆ',B:'æŠ•ä¿å¾Œéœ€éä¸€å®šæœŸé–“æ‰ç”Ÿæ•ˆ',C:'åªæœ‰æ„å¤–æ‰æœ‰ç­‰å¾…æœŸ'},a:'B'}},
        {id:4,left:'64%',top:'46%',label:'æ™‚å…‰å±±æ´',reward:'token4', q:{t:'å¹´é½¡èˆ‡é•·ç…§éšªä¿è²»é—œä¿‚ï¼Ÿ',c:{A:'å¹´é½¡è¶Šå°é€šå¸¸è¶Šä½',B:'å¹´é½¡è¶Šå°é€šå¸¸è¶Šé«˜',C:'ç„¡é—œ'},a:'A'}},
        {id:5,left:'84%',top:'34%',label:'å®‰å¿ƒæ¸¯ç£',reward:'token5', q:{t:'é”åˆ°é•·ç…§é–€æª»å¾Œï¼Œå¿…é ˆä½æ©Ÿæ§‹æ‰å¯è«‹é ˜ï¼Ÿ',c:{A:'æ˜¯ï¼Œå¿…é ˆå…¥ä½',B:'å¦ï¼Œå¤šæ•¸å•†å“èˆ‡ç…§è­·åœ°é»ç„¡é—œï¼ˆä»¥æ¢æ¬¾ç‚ºæº–ï¼‰',C:'åªæœ‰ä½é™¢æ‰å¯è«‹é ˜'},a:'B'}}
      ]
    },
    { key:'mount', name:'ç¬¬ 2 ç« ï½œå·–å³°ç§˜å¢ƒ',
      bg:'https://media.istockphoto.com/id/501279187/vector/treasure-map.jpg?s=2048x2048&w=is&k=20&c=MU0IpBmOxDgqZg4SWNyugWCcBhlx5B-8obDBdR12igk=',
      trailSpots:[
        {id:6,left:'16%',top:'74%',label:'å±±è…³ç‡Ÿåœ°',reward:'token6', q:{t:'æ—¥å¸¸é•·ç…§æˆæœ¬å¸¸åŒ…å«ï¼Ÿ',c:{A:'åƒ…æˆ¿ç§Ÿ',B:'ç”Ÿæ´»ç…§è­·ã€å¾©å¥ã€çœ‹è­·/æ©Ÿæ§‹è²»ç­‰',C:'åªæœ‰æ‰‹è¡“è²»'},a:'B'}},
        {id:7,left:'36%',top:'63%',label:'å·–æ´å‰å“¨',reward:'token7', q:{t:'è©•ä¼°é•·ç…§éœ€æ±‚å¸¸è¦‹æŒ‡æ¨™ï¼Ÿ',c:{A:'CDRé‡è¡¨/å·´æ°é‡è¡¨',B:'èº«é«˜é«”é‡',C:'é‹ç¢¼'},a:'A'}},
        {id:8,left:'56%',top:'53%',label:'é¤˜ç‡¼ç¥­å£‡',reward:'token8', q:{t:'ç†è³ è§¸ç™¼å¸¸åŒ…å«ï¼Ÿ',c:{A:'é”ç”Ÿç†éšœç¤™æˆ–èªçŸ¥éšœç¤™ï¼ˆå¦‚å¤±æ™ºï¼‰',B:'å¿ƒæƒ…ä¸å¥½',C:'è³¼è²·ä¿å¥é£Ÿå“'},a:'A'}},
        {id:9,left:'76%',top:'42%',label:'é«˜å¶ºæ¸…æ³‰',reward:'token9', q:{t:'å±…å®¶ç…§è­·èˆ‡æ©Ÿæ§‹ç…§è­·ä¸»è¦å·®ç•°ï¼Ÿ',c:{A:'ç…§è­·åœ°é»èˆ‡äººåŠ›å®‰æ’',B:'æ˜¯å¦èƒ½çœ‹é›»è¦–',C:'æ˜¯å¦å–æ‰‹æ–é£²'},a:'A'}},
        {id:10,left:'90%',top:'30%',label:'å·”å³°æ˜Ÿå°',reward:'token10', q:{t:'è¦åŠƒé•·ç…§é¢¨éšªè¼ƒä½³åšæ³•ï¼Ÿ',c:{A:'åªé ç¾é‡‘å„²è“„',B:'è©•ä¼°é¢¨éšªç¼ºå£ï¼Œä»¥ä¿éšªï¼‹å„²è“„/æŠ•è³‡åˆ†æ•£',C:'å®Œå…¨ä¸éœ€è¦è¦åŠƒ'},a:'B'}}
      ]
    }
  ];

  // ---- ç‹€æ…‹ ----
  let state={completed:{}, chap:0, pointerId:1};

  // ---- DOM ----
  const board=document.getElementById('board');
  const bg=document.getElementById('bg');
  const progressPill=document.getElementById('progressPill');
  const chapBtns=[document.getElementById('chap0'), document.getElementById('chap1')];
  const mascot=document.getElementById('mascot');
  const qDialog=document.getElementById('qDialog');
  const qForm=document.getElementById('qForm');
  const qTitle=document.getElementById('qTitle');
  const qText=document.getElementById('qText');
  const qChoices=document.getElementById('qChoices');
  const qFeedback=document.getElementById('qFeedback');
  const finishDialog=document.getElementById('finishDialog');

  const overallDone=()=> CHAPTERS.flatMap(c=>c.trailSpots).every(s=>state.completed[s.id]);

  // ç« ç¯€åˆ‡æ›
  chapBtns.forEach((btn,idx)=>{
    btn.onclick=()=>{
      state.chap=idx; renderBoard(); renderChaps();
      moveMascotTo(CHAPTERS[idx].trailSpots.find(s=>state.completed[s.id]) || CHAPTERS[idx].trailSpots[0]);
    };
  });

  document.getElementById('resetBtn').onclick=()=>{
    state={completed:{},chap:0,pointerId:1};
    renderChaps(); renderBoard(); moveMascotTo(CHAPTERS[0].trailSpots[0]);
  };

  function renderChaps(){
    chapBtns.forEach((b,i)=>{
      const done = CHAPTERS[i].trailSpots.every(s=>state.completed[s.id]);
      b.classList.toggle('active', i===state.chap);
      b.classList.toggle('done', done);
    });
  }

  function renderBoard(){
    const ch=CHAPTERS[state.chap];
    bg.src = ch.bg;
    Array.from(board.querySelectorAll('.spot')).forEach(n=>n.remove());
    ch.trailSpots.forEach(s=>{
      const el=document.createElement('button');
      el.className='spot'; el.style.left=s.left; el.style.top=s.top; el.dataset.id=s.id;
      el.innerHTML='<span class="label">'+s.label+'ï¼ˆ'+s.id+'ï¼‰</span>';
      const playable=(s.id===state.pointerId);
      const passed=!!state.completed[s.id];
      if(!playable && !passed) el.classList.add('locked');
      if(passed) el.classList.add('completed');
      el.onclick=()=> onSpotClick(s, playable, passed);
      board.appendChild(el);
    });
    renderProgress();
  }

  function renderProgress(){
    const total = CHAPTERS.reduce((n,ch)=>n+ch.trailSpots.length,0);
    const done = Object.keys(state.completed).length;
    progressPill.textContent='é€²åº¦ï¼š'+done+' / '+total;
    if(done===total && !finishDialog.open) finishDialog.showModal();
  }

  function moveMascotTo(spot, cb){
    if(!spot) return;
    mascot.style.left=spot.left; mascot.style.top=spot.top;
    setTimeout(()=> cb && cb(), 900);
  }

  // å•é¡Œäº’å‹•
  let mode='play', currentSpot=null;

  function onSpotClick(s, playable, passed){
    if(passed && !playable){ mode='review'; openQuestion(s); return; }
    if(!playable) return; mode='play'; openQuestion(s);
  }

  function openQuestion(s){
    currentSpot=s;
    qTitle.textContent='ã€'+s.id+'ã€‘'+s.label + (mode==='review'?'ï¼ˆå·²é€šé—œï½œåƒ…ç€è¦½ï¼‰':''); 
    qText.textContent=s.q.t;
    qChoices.innerHTML='';
    for(const [k,label] of Object.entries(s.q.c)){
      const row=document.createElement('label');
      row.className='choice';
      row.innerHTML='<input type="radio" name="opt" value="'+k+'" '+(mode==='review'?'disabled':'')+' />'
                   +'<div><strong>'+k+'.</strong> '+label+'</div>';
      qChoices.appendChild(row);
    }
    qFeedback.style.display='none';
    if(mode==='review'){ qFeedback.className='feedback ok'; qFeedback.textContent='æ­£ç¢ºç­”æ¡ˆï¼š'+s.q.a; qFeedback.style.display='block'; }
    qDialog.showModal();
  }

  qForm.addEventListener('submit', (e)=>{
    if(mode==='review') return;
    const fd=new FormData(qForm); const pick=fd.get('opt');
    if(!pick){ e.preventDefault(); qFeedback.className='feedback no'; qFeedback.textContent='è«‹å…ˆé¸æ“‡ä¸€å€‹é¸é …å”·ã€‚'; qFeedback.style.display='block'; return; }
    if(e.submitter && e.submitter.value==='ok'){ e.preventDefault();
      const ok=(pick===currentSpot.q.a); qFeedback.style.display='block';
      if(ok){
        qFeedback.className='feedback ok'; qFeedback.textContent='ç­”å°äº†ï¼';
        state.completed[currentSpot.id]=true;
        const token=document.getElementById(currentSpot.reward); if(token) token.classList.add('unlock');

        // â˜… é—œéµä¿®æ­£ï¼šè‹¥å…¨æ•¸å®Œæˆï¼Œç›´æ¥è·³è­‰æ›¸ï¼Œä¸å†è‡ªå‹•é–‹ä¸‹ä¸€é¡Œ
        if(overallDone()){
          renderChaps(); renderBoard();
          setTimeout(()=>{ qDialog.close(); finishDialog.showModal(); }, 400);
          return;
        }

        // å¦å‰‡æ­£å¸¸å‰é€²
        const allIds=CHAPTERS.flatMap(c=>c.trailSpots.map(x=>x.id));
        const curIndex=allIds.indexOf(currentSpot.id);
        state.pointerId = allIds[curIndex+1] || state.pointerId;

        const ch=CHAPTERS[state.chap]; const idx=ch.trailSpots.findIndex(x=>x.id===currentSpot.id);
        let next=ch.trailSpots[idx+1];
        if(!next){
          if(state.chap < CHAPTERS.length-1){ state.chap++; }
          next = CHAPTERS[state.chap].trailSpots[0];
        }
        renderChaps(); renderBoard();
        setTimeout(()=>{ qDialog.close(); moveMascotTo(next, ()=> openQuestion(next)); }, 600);
      }else{
        qFeedback.className='feedback no'; qFeedback.textContent='ç­”éŒ¯äº†ï¼Œå†æƒ³æƒ³ï¼';
      }
    }
  });

  // è­‰æ›¸ï¼šç”Ÿæˆæˆ–é—œé–‰å¾Œéƒ½å›åˆ°ç¬¬ 1 ç« ç¬¬ 1 é¡Œä¸¦è‡ªå‹•é–‹é¡Œ
  document.getElementById('finishCloseBtn').addEventListener('click', ()=>{
    finishDialog.close();
    state={completed:{}, chap:0, pointerId:1};
    renderChaps(); renderBoard();
    setTimeout(()=> onSpotClick(CHAPTERS[0].trailSpots[0], true, false), 300);
  });

  document.getElementById('makeCertBtn').addEventListener('click', ()=>{
    const name=(document.getElementById('certName').value||'å„ªç§€æ¢éšªå®¶').trim();
    const W=1400,H=900; const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');
    const bg=ctx.createLinearGradient(0,0,0,H); bg.addColorStop(0,'#fff7e0'); bg.addColorStop(1,'#edd3a0'); ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
    // èŠ±é‚Š
    ctx.strokeStyle='#8a5a24'; ctx.lineWidth=6; ctx.strokeRect(40,40,W-80,H-80);
    ctx.setLineDash([10,8]); ctx.lineWidth=2; ctx.strokeRect(70,70,W-140,H-140); ctx.setLineDash([]);
    // æ–‡å­—
    ctx.textAlign='center'; ctx.fillStyle='#4a3b22';
    ctx.font='56px "Noto Sans TC",system-ui'; ctx.fillText('é•·ç…§éšªçŸ¥è­˜æ¢éšªï½œæ¦®è­½è­‰æ›¸', W/2, 160);
    ctx.font='64px "Noto Sans TC",system-ui'; ctx.fillStyle='#1f1b16'; ctx.fillText(name, W/2, 260);
    ctx.font='28px "Noto Sans TC",system-ui'; ctx.fillStyle='#2b2418';
    const total=CHAPTERS.reduce((n,ch)=>n+ch.trailSpots.length,0);
    wrapText(ctx, 'å®Œæˆæœ¬æ´»å‹•æ‰€æœ‰ç« ç¯€èˆ‡é—œå¡ï¼ŒæˆåŠŸæ”¶é›† '+total+' ä»¶å¯¶ç‰©ï¼Œå±•ç¾äº†å°é•·æœŸç…§è­·é¢¨éšªèˆ‡ä¿éšœè§€å¿µçš„ç†è§£èˆ‡é‡è¦–ã€‚ç‰¹æ­¤å˜‰è¨±ï¼', W/2, 330, 1000, 36);
    const badges=['ğŸš','ğŸ’','ğŸŒ¿','â³','âš“','ğŸªµ','ğŸª¨','ğŸ”¥','ğŸ’§','ğŸŒŸ']; ctx.font='48px serif';
    let x=W/2 - (badges.length/2)*80 + 40, y=540; badges.forEach(b=>{ ctx.fillText(b,x,y); x+=80; });
    ctx.font='24px "Noto Sans TC",system-ui'; ctx.fillStyle='#3a2f1f';
    ctx.fillText('å®Œæˆæ—¥æœŸï¼š'+new Date().toLocaleDateString('zh-TW'), W/2, 680);
    ctx.fillText('ï¼ˆæœ¬è­‰æ›¸ç‚ºæ´»å‹•å®Œæˆç´€å¿µï¼Œéæ­£å¼å­¸è¡“/å°ˆæ¥­è­‰ç…§ï¼‰', W/2, 720);
    ctx.beginPath(); ctx.moveTo(W/2-220, 770); ctx.lineTo(W/2+220, 770); ctx.strokeStyle='#6b4d24'; ctx.lineWidth=2; ctx.stroke();
    ctx.font='bold 22px "Noto Sans TC",system-ui'; ctx.fillText('é‚¦é‚¦å­¸é™¢ æ¥­å‹™è¡ŒéŠ·éƒ¨', W/2, 802);
    const url=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='é•·ç…§éšªæ¢éšª_é›»å­è­‰æ›¸_'+name+'.png'; document.body.appendChild(a); a.click(); a.remove();

    // ä¸‹è¼‰å®Œå›ç¬¬ä¸€ç« ç¬¬ä¸€é¡Œä¸¦è‡ªå‹•é–‹é¡Œ
    setTimeout(()=>{
      finishDialog.close();
      state={completed:{}, chap:0, pointerId:1};
      renderChaps(); renderBoard();
      setTimeout(()=> onSpotClick(CHAPTERS[0].trailSpots[0], true, false), 300);
    }, 300);
  });

  function wrapText(ctx,text,cx,y,maxWidth,lineHeight){
    const chars=[...text]; let line='', lines=[];
    for(const ch of chars){ const test=line+ch; if(ctx.measureText(test).width>maxWidth){ lines.push(line); line=ch; } else line=test; }
    if(line) lines.push(line);
    lines.forEach((ln,i)=> ctx.fillText(ln,cx,y+i*lineHeight));
  }

  // åˆå§‹
  renderChaps(); renderBoard(); moveMascotTo(CHAPTERS[state.chap].trailSpots[0]);
})();
</script>
</body>
</html>
